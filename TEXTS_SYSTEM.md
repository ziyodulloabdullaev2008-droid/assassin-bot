# Система управления текстами рассылки

## Обзор

Реализована полнофункциональная система управления текстами с поддержкой:
- ✅ Множественных текстов в одной рассылке
- ✅ Двух режимов выбора: Random и Sequence
- ✅ Добавления, редактирования, удаления текстов
- ✅ Просмотра списка текстов
- ✅ Переключения режимов из главного меню

## Структура данных

### config['texts']
- Тип: список строк (list)
- Описание: Список всех текстов рассылки
- Пример: `["Первый текст", "Второй текст", "Третий текст"]`

### config['text_mode']
- Тип: строка (str)
- Значения: `'random'` или `'sequence'`
- Описание: Режим выбора текстов
  - `'random'` - случайный выбор из списка
  - `'sequence'` - последовательный выбор (в порядке)
- По умолчанию: `'random'`

### config['text_index']
- Тип: целое число (int)
- Описание: Текущий индекс для режима sequence
- По умолчанию: `0`

## FSM Состояния

Добавлены два новых состояния в `BroadcastConfigState`:

```python
waiting_for_text_add = State()    # Ввод нового текста
waiting_for_text_edit = State()   # Редактирование существующего текста
```

## Callbacks

### bc_text
Открывает меню управления текстами с опциями:
- Просмотр списка текстов
- Переключение режима (Random ↔ Sequence)
- Возврат в главное меню

### text_list
Показывает список добавленных текстов для выбора и просмотра.

### text_view_{index}
Показывает конкретный текст с опциями:
- Изменить текст
- Удалить текст
- Вернуться к списку

### text_edit_{index}
Переводит в режим редактирования выбранного текста.

### text_delete_{index}
Удаляет текст из списка и показывает обновленный список.

### text_add_new
Переводит в режим добавления нового текста.

### text_mode_toggle
Переключает режим между Random и Sequence.

## Message Handlers

### process_text_add
Обработчик для сохранения нового добавляемого текста.

### process_text_edit
Обработчик для сохранения отредактированного текста.

## Функции Helper

### build_texts_keyboard(texts: list, back_callback: str)
Строит клавиатуру для списка текстов (3 кнопки в ряду).

### build_text_settings_keyboard(text_mode: str)
Строит меню настроек текстов (список, режим, назад).

## Логика отправки (schedule_broadcast_send)

Функция теперь поддерживает:
- Параметр `texts` - список текстов для рассылки
- Параметр `text_mode` - режим выбора
- Для random mode: случайный выбор текста из списка для каждого сообщения
- Для sequence mode: последовательный выбор текстов, переход на следующий при каждом чате

### Примеры использования

```python
# Random режим - каждое сообщение случайный текст
await schedule_broadcast_send(
    user_id=123, 
    account_number=1,
    chat_ids=[...],
    texts=["Текст 1", "Текст 2", "Текст 3"],
    text_mode='random'
)

# Sequence режим - каждый чат получает свой текст
await schedule_broadcast_send(
    user_id=123, 
    account_number=1,
    chat_ids=[...],
    texts=["Текст 1", "Текст 2", "Текст 3"],
    text_mode='sequence'
)
```

## Миграция данных

Система автоматически конвертирует старый формат:
- Старый: `config['text']` = "текст"
- Новый: `config['texts']` = ["текст"]
- `config['text_mode']` = 'random' (по умолчанию)

Конверсия происходит в `get_broadcast_config()` при первом обращении.

## Интеграция с главным меню

Главное меню (`cmd_broadcast_menu`) теперь показывает:
- Количество добавленных текстов
- Текущий режим выбора (Random или No Random)
- Все остальные параметры рассылки

Пример вывода:
```
📤 РАССЫЛКА

💬 Текстов: 3 ✅
🔢 Кол-во: 1
⏱️ Интервал: 10-30 мин
⏸️ Пауза между батчами: 2-5 сек
🎲 Режим: Random ✅
💭 Чатов: 25

Активных рассылок: 0
```

## Проверки валидации

- ✅ Нельзя запустить рассылку без текстов
- ✅ При удалении текста в sequence режиме индекс сбрасывается если нужно
- ✅ Текст обрезается при отображении если больше 3500 символов
- ✅ При переключении режима индекс сбрасывается на 0

## Использование

1. Перейти в меню рассылки `/broadcast`
2. Нажать на кнопку "Текст"
3. Выбрать "Список текстов"
4. Добавить новые тексты кнопкой "Добавить новый"
5. Редактировать или удалять существующие тексты
6. Переключать режим кнопкой "Режим: Random ✅"
7. Запустить рассылку кнопкой "Запустить"
